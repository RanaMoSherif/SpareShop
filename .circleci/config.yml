version: 2.1

jobs:
  build-and-test:
    docker:
      - image: mcr.microsoft.com/dotnet/sdk:7.0
    resource_class: small
    steps:
      - checkout
      - run:
          name: Install unzip
          command: apt-get update && apt-get install -y unzip
      - run:
          name: Find .sln file and run dotnet restore
          command: |
            SLN_FILE=$(find . -name "*.sln")
            echo "Found solution file: $SLN_FILE"
            dotnet restore $SLN_FILE
      - run:
          name: Find .sln file and run dotnet publish
          command: |
            SLN_FILE=$(find . -name "*.sln")
            echo "Found solution file: $SLN_FILE"
            dotnet publish $SLN_FILE -c Release -o out
      - dotnet-sonarscanner/sonar-install
      - dotnet-sonarscanner/sonar-begin
      - dotnet-sonarscanner/sonar-end

orbs:
  dotnet-sonarscanner: storytel/dotnet-sonarscanner@1.4.3

workflows:
  version: 2
  sample:
    jobs:
      - build-and-test
          context: dotnet-sonarscanner
